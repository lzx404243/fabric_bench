#!/bin/bash
#SBATCH --partition=compute
#SBATCH --account=uic193
#SBATCH --time=02:00
#SBATCH --nodes=2
#SBATCH --ntasks-per-node=128
#SBATCH --exclusive
#SBATCH --job-name=basic
#SBATCH --output=slurm_output_%j.txt
#SBATCH --error=slurm_error_%j.txt

fabric=ibv
path_to_exe=${1:-/home/zli89/clion_fb/cmake-build-debug/benchmark/${fabric}}
allComputeTime=(0 10)


for compute_time in ${allComputeTime[@]}; do

export OMP_PLACES=cores
echo "srun -n 2 prg_${fabric}_compute(1 prg-${compute_time}us-prefill)"
srun --nodes=2 --ntasks-per-node=1 --ntasks=2 --mpi=pmi2 ${path_to_exe}/pingpong_prg 15 1 8 8 '15' ${compute_time} 8
srun --nodes=2 --ntasks-per-node=1 --ntasks=2 --mpi=pmi2 ${path_to_exe}/pingpong_prg 31 1 8 8 '31' ${compute_time} 8
srun --nodes=2 --ntasks-per-node=1 --ntasks=2 --mpi=pmi2 ${path_to_exe}/pingpong_prg 63 1 8 8 '63' ${compute_time} 8
srun --nodes=2 --ntasks-per-node=1 --ntasks=2 --mpi=pmi2 ${path_to_exe}/pingpong_prg 127 1 8 8 '127' ${compute_time} 8

export OMP_PROC_BIND=close;
export OMP_PLACES=cores
echo "srun -n 2 prg_${fabric}_compute(2 prg-${compute_time}us-prefill)"
srun --nodes=2 --ntasks-per-node=1 --ntasks=2 --mpi=pmi2 ${path_to_exe}/pingpong_prg 14 2 8 8 '14,15' ${compute_time} 8
export OMP_PLACES='{0},{16},{1},{17},{2},{18},{3},{19},{4},{20},{5},{21},{6},{22},{7},{23},{8},{24},{9},{25},{10},{26},{11},{27},{12},{28},{13},{29},{14},{30}'
srun --nodes=2 --ntasks-per-node=1 --ntasks=2 --mpi=pmi2 ${path_to_exe}/pingpong_prg 30 2 8 8 '15,31' ${compute_time} 8
export OMP_PLACES='{0},{16},{32},{48},{1},{17},{33},{49},{2},{18},{34},{50},{3},{19},{35},{51},{4},{20},{36},{52},{5},{21},{37},{53},{6},{22},{38},{54},{7},{23},{39},{55},{8},{24},{40},{56},{9},{25},{41},{57},{10},{26},{42},{58},{11},{27},{43},{59},{12},{28},{44},{60},{13},{29},{45},{61},{14},{30},{46},{62},{15},{31}'
srun --nodes=2 --ntasks-per-node=1 --ntasks=2 --mpi=pmi2 ${path_to_exe}/pingpong_prg 62 2 8 8 '47,63' ${compute_time} 8
export OMP_PLACES='{0},{64},{1},{65},{2},{66},{3},{67},{4},{68},{5},{69},{6},{70},{7},{71},{8},{72},{9},{73},{10},{74},{11},{75},{12},{76},{13},{77},{14},{78},{15},{79},{16},{80},{17},{81},{18},{82},{19},{83},{20},{84},{21},{85},{22},{86},{23},{87},{24},{88},{25},{89},{26},{90},{27},{91},{28},{92},{29},{93},{30},{94},{31},{95},{32},{96},{33},{97},{34},{98},{35},{99},{36},{100},{37},{101},{38},{102},{39},{103},{40},{104},{41},{105},{42},{106},{43},{107},{44},{108},{45},{109},{46},{110},{47},{111},{48},{112},{49},{113},{50},{114},{51},{115},{52},{116},{53},{117},{54},{118},{55},{119},{56},{120},{57},{121},{58},{122},{59},{123},{60},{124},{61},{125},{62},{126}'
srun --nodes=2 --ntasks-per-node=1 --ntasks=2 --mpi=pmi2 ${path_to_exe}/pingpong_prg 126 2 8 8 '63,127' ${compute_time} 8

echo "srun -n 2 prg_${fabric}_compute(4 prg-${compute_time}us-prefill)"
export OMP_PLACES='{0},{16},{1},{17},{2},{18},{3},{19},{4},{20},{5},{21},{6},{22},{7},{23},{8},{24},{9},{25},{10},{26},{11},{27},{12},{28},{13},{29}'
srun --nodes=2 --ntasks-per-node=1 --ntasks=2 --mpi=pmi2 ${path_to_exe}/pingpong_prg 28 4 8 8 '14,30,15,31' ${compute_time} 8
export OMP_PLACES='{0},{16},{32},{48},{1},{17},{33},{49},{2},{18},{34},{50},{3},{19},{35},{51},{4},{20},{36},{52},{5},{21},{37},{53},{6},{22},{38},{54},{7},{23},{39},{55},{8},{24},{40},{56},{9},{25},{41},{57},{10},{26},{42},{58},{11},{27},{43},{59},{12},{28},{44},{60},{13},{29},{45},{61},{14},{30},{46},{62}'
srun --nodes=2 --ntasks-per-node=1 --ntasks=2 --mpi=pmi2 ${path_to_exe}/pingpong_prg 60 4 8 8 '15,31,47,63' ${compute_time} 8
export OMP_PLACES='{0},{32},{64},{96},{1},{33},{65},{97},{2},{34},{66},{98},{3},{35},{67},{99},{4},{36},{68},{100},{5},{37},{69},{101},{6},{38},{70},{102},{7},{39},{71},{103},{8},{40},{72},{104},{9},{41},{73},{105},{10},{42},{74},{106},{11},{43},{75},{107},{12},{44},{76},{108},{13},{45},{77},{109},{14},{46},{78},{110},{15},{47},{79},{111},{16},{48},{80},{112},{17},{49},{81},{113},{18},{50},{82},{114},{19},{51},{83},{115},{20},{52},{84},{116},{21},{53},{85},{117},{22},{54},{86},{118},{23},{55},{87},{119},{24},{56},{88},{120},{25},{57},{89},{121},{26},{58},{90},{122},{27},{59},{91},{123},{28},{60},{92},{124},{29},{61},{93},{125},{30},{62},{94},{126}'
srun --nodes=2 --ntasks-per-node=1 --ntasks=2 --mpi=pmi2 ${path_to_exe}/pingpong_prg 124 4 8 8 '31,63,95,127' ${compute_time} 8

echo "srun -n 2 prg_${fabric}_compute(8 prg-${compute_time}us-prefill)"
export OMP_PLACES='{0},{16},{32},{48},{1},{17},{33},{49},{2},{18},{34},{50},{3},{19},{35},{51},{4},{20},{36},{52},{5},{21},{37},{53},{6},{22},{38},{54},{7},{23},{39},{55},{8},{24},{40},{56},{9},{25},{41},{57},{10},{26},{42},{58},{11},{27},{43},{59},{12},{28},{44},{60},{13},{29},{45},{61}'
srun --nodes=2 --ntasks-per-node=1 --ntasks=2 --mpi=pmi2 ${path_to_exe}/pingpong_prg 56 8 8 8 '14,30,46,62,15,31,47,63' ${compute_time} 8
export OMP_PLACES='{0},{16},{32},{48},{64},{80},{96},{112},{1},{17},{33},{49},{65},{81},{97},{113},{2},{18},{34},{50},{66},{82},{98},{114},{3},{19},{35},{51},{67},{83},{99},{115},{4},{20},{36},{52},{68},{84},{100},{116},{5},{21},{37},{53},{69},{85},{101},{117},{6},{22},{38},{54},{70},{86},{102},{118},{7},{23},{39},{55},{71},{87},{103},{119},{8},{24},{40},{56},{72},{88},{104},{120},{9},{25},{41},{57},{73},{89},{105},{121},{10},{26},{42},{58},{74},{90},{106},{122},{11},{27},{43},{59},{75},{91},{107},{123},{12},{28},{44},{60},{76},{92},{108},{124},{13},{29},{45},{61},{77},{93},{109},{125},{14},{30},{46},{62},{78},{94},{110},{126}'
srun --nodes=2 --ntasks-per-node=1 --ntasks=2 --mpi=pmi2 ${path_to_exe}/pingpong_prg 120 8 8 8 '15,31,47,63,79,95,111,127' ${compute_time} 8

echo "srun -n 2 prg_${fabric}_compute(16 prg-${compute_time}us-prefill)"
export OMP_PLACES='{0},{16},{32},{48},{64},{80},{96},{112},{1},{17},{33},{49},{65},{81},{97},{113},{2},{18},{34},{50},{66},{82},{98},{114},{3},{19},{35},{51},{67},{83},{99},{115},{4},{20},{36},{52},{68},{84},{100},{116},{5},{21},{37},{53},{69},{85},{101},{117},{6},{22},{38},{54},{70},{86},{102},{118},{7},{23},{39},{55},{71},{87},{103},{119},{8},{24},{40},{56},{72},{88},{104},{120},{9},{25},{41},{57},{73},{89},{105},{121},{10},{26},{42},{58},{74},{90},{106},{122},{11},{27},{43},{59},{75},{91},{107},{123},{12},{28},{44},{60},{76},{92},{108},{124},{13},{29},{45},{61},{77},{93},{109},{125}'
srun --nodes=2 --ntasks-per-node=1 --ntasks=2 --mpi=pmi2 ${path_to_exe}/pingpong_prg 112 16 8 8 '14,30,46,62,78,94,110,126,15,31,47,63,79,95,111,127' ${compute_time} 8

done # end of experiments for a compute time
